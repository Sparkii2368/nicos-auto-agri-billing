<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Nico’s Auto & Agri — Billing</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
  :root{--brand:#0f7b6c;--bg:#f9fafb;--line:#e5e7eb;}
  body{font-family:system-ui,sans-serif;background:var(--bg);color:#1f2937;padding:12px;max-width:980px;margin:auto;line-height:1.5;}
  nav{position:fixed;bottom:0;left:0;right:0;background:#fff;z-index:999;box-shadow:0 -4px 20px rgba(0,0,0,.1);padding:12px;display:flex;gap:10px;justify-content:center;}
  nav button{padding:16px 24px;border:1px solid var(--brand);border-radius:12px;background:#fff;color:var(--brand);font-weight:700;font-size:1.1rem;flex:1;max-width:220px;}
  nav button.active{background:var(--brand);color:#fff;}
  .sheet{background:#fff;border:1px solid var(--line);border-radius:16px;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding-bottom:100px;}
  .sheet>header{display:flex;gap:20px;align-items:center;border-bottom:2px solid var(--line);padding-bottom:16px;margin-bottom:20px;}
  #logo{width:180px;height:auto;}
  h1{margin:0;font-size:26px;color:var(--brand);font-weight:800;}
  .card{border:1px solid var(--line);border-radius:12px;padding:18px;margin:14px 0;background:#fff;}
  .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px;}
  .col-3{grid-column:span 3;}.col-4{grid-column:span 4;}.col-6{grid-column:span 6;}
  @media (max-width:720px){.col-3,.col-4,.col-6{grid-column:span 12;}}
  label{font-weight:600;color:#555;margin-bottom:6px;display:block;}
  input,select,textarea{width:100%;padding:12px;border:1px solid var(--line);border-radius:10px;font-size:1rem;}
  textarea{min-height:100px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;}
  th,td{padding:12px;border-bottom:1px solid #eee;}
  th{background:#f8f9fa;color:#555;font-weight:700;}
  .btn{background:var(--brand);color:#fff;border:none;border-radius:12px;padding:14px 24px;font-weight:700;cursor:pointer;font-size:1.05rem;}
  .btn.outline{background:transparent;color:var(--brand);border:2px solid var(--brand);}
  .actions{display:flex;gap:12px;flex-wrap:wrap;margin-top:20px;}
  .right{text-align:right;}
  .hidden{display:none;}
  @media (max-width:480px){
    #itemsTbl thead{display:none;}
    #itemsTbl tr,#itemsTbl td{display:block;width:100%;border-bottom:1px solid var(--line);padding:10px 0;}
    #itemsTbl td::before{content:attr(data-label);font-weight:700;color:#555;display:block;margin-bottom:6px;}
    #itemsTbl td:last-child{display:none;}
  }
</style>
</head>
<body>

<nav>
  <button id="tabCreate" class="active">Create</button>
  <button id="tabRecords">Records</button>
</nav>

<section id="createView" class="sheet">
  <header>
    <img id="logo" src="logo.png" alt="" onerror="this.style.display='none'">
    <div>
      <h1>Nico’s Auto & Agri</h1>
      <p style="color:#666;margin:4px 0;">98 Diemeer Str, Welgelegen, Polokwane<br>Tel: 079 568 1706 / 067 277 0183</p>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div class="col-3"><label>Type</label><select id="docType">
        <option value="QUOTE">Quote</option>
        <option value="PRO_FORMA">Pro forma</option>
        <option value="TAX_INVOICE" selected>Tax Invoice</option>
      </select></div>
      <div class="col-3"><label>PO #</label><input id="customerPO"></div>
      <div class="col-3"><label>No.</label><input id="invNumber" readonly></div>
      <div class="col-3"><label>Currency</label><select id="currency"><option>ZAR</option><option>USD</option><option>EUR</option></select></div>
      <div class="col-4"><label>Date</label><input id="invDate" type="date"></div>
      <div class="col-4"><label>Due</label><input id="dueDate" type="date"></div>
      <div class="col-4"><label>VAT %</label><input id="vatRate" type="number" step="0.01" value="15"></div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col-6">
        <label>Client</label><input id="clientCompany" placeholder="Company">
        <label>Contact</label><input id="clientRep" placeholder="Name">
        <label>VAT</label><input id="clientVAT">
        <label>Address</label><input id="clientAddress">
        <label>Email</label><input id="clientEmail" type="email">
        <label>Saved clients</label><select id="clientPicker"><option value="">— Select —</option></select>
        <div class="actions"><button class="btn outline" id="saveClientBtn">Save</button><button class="btn outline" id="deleteClientBtn">Delete</button></div>
      </div>
      <div class="col-6">
        <label>Your VAT</label><input id="bizVAT" placeholder="Your VAT number">
      </div>
    </div>
  </div>

  <div class="card">
    <label>Items</label>
    <table id="itemsTbl">
      <thead><tr><th>Description</th><th>Qty</th><th>Price</th><th>Markup %</th><th class="right">Total</th><th></th></tr></thead>
      <tbody id="itemsBody"></tbody>
      <tfoot><tr><td colspan="6"><button class="btn outline" id="addItem">+ Add Item</button></td></tr></tfoot>
    </table>
  </div>

  <div class="card">
    <div class="row">
      <div class="col-6">
        <label>Notes</label>
        <textarea id="notes" placeholder="Thank you..."></textarea>
        <label>Payment link</label>
        <input id="payLink" placeholder="https://pay.yoco.link/...">
      </div>
      <div class="col-6">
        <table style="font-size:1.2rem;width:100%;">
          <tr><td>Subtotal</td><td class="right" id="subtotal">R 0.00</td></tr>
          <tr><td>Discount %</td><td class="right"><input id="discountRate" type="number" step="0.01" value="0" style="width:80px;"></td></tr>
          <tr><td>VAT</td><td class="right" id="vat">R 0.00</td></tr>
          <tr><td><strong>TOTAL</strong></td><td class="right" id="grand"><strong>R 0.00</strong></td></tr>
        </table>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="saveBtn">Save</button>
      <button class="btn" id="pdfBtn">Download PDF</button>
      <button class="btn outline" id="emailBtn">Email</button>
      <button class="btn outline" id="convertBtn">Convert to Invoice</button>
    </div>
  </div>
</section>

<section id="recordsView" class="sheet hidden">
  <header><h1>Records</h1></header>
  <input id="searchBox" placeholder="Search..." style="width:100%;padding:12px;margin:16px 0;border-radius:10px;border:1px solid #ddd;">
  <div class="card"><h3>Quotes</h3><table id="tblQuotes"><thead><tr><th>No.</th><th>Date</th><th>Client</th><th class="right">Amount</th><th></th></tr></thead><tbody></tbody></table></div>
  <div class="card"><h3>Pro forma</h3><table id="tblProforma"><thead><tr><th>No.</th><th>Date</th><th>Client</th><th class="right">Amount</th><th></th></tr></thead><tbody></tbody></table></div>
  <div class="card"><h3>Tax Invoices</h3><table id="tblTax"><thead><tr><th>No.</th><th>Date</th><th>Client</th><th class="right">Amount</th><th></th></tr></thead><tbody></tbody></table></div>
</section>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<script>
const { DateTime } = luxon;
const { jsPDF } = window.jspdf;
const $ = s => document.querySelector(s);
const $$ = s => [...document.querySelectorAll(s)];

const prefixes = { QUOTE:'QUO', PRO_FORMA:'PFI', TAX_INVOICE:'NAA' };
Object.keys(prefixes).forEach(k => localStorage.getItem('c_'+k) || localStorage.setItem('c_'+k, '1'));

$('#tabCreate').onclick = () => show('create');
$('#tabRecords').onclick = () => { show('records'); refreshRecords(); };
function show(v) {
  $('#createView').classList.toggle('hidden', v !== 'create');
  $('#recordsView').classList.toggle('hidden', v !== 'records');
  $('#tabCreate').classList.toggle('active', v === 'create');
  $('#tabRecords').classList.toggle('active', v === 'records');
}

const fmt = (n, cur='ZAR') => (cur==='USD'?'$':cur==='EUR'?'€':'R') + ' ' + Number(n||0).toLocaleString('en-ZA', {minimumFractionDigits:2, maximumFractionDigits:2});

function setNumber() {
  const type = $('#docType').value;
  if (!$('#invNumber').value) {
    const n = +localStorage.getItem('c_'+type);
    $('#invNumber').value = prefixes[type] + String(n).padStart(4,'0');
  }
}
$('#docType').onchange = () => { setNumber(); applyNote(); };

function applyNote() {
  if (['QUOTE','PRO_FORMA'].includes($('#docType').value) && !$('#notes').value.trim()) {
    $('#notes').value = 'Quote valid for 7 days • 5-day warranty on mechanical parts • 2.5% card payment fee applies';
  }
}

function addItem(d='',q=1,p=0,m=0) {
  const tr = document.createElement('tr');
  tr.innerHTML = `<td data-label="Desc"><input class="desc" value="${d}"></td>
    <td data-label="Qty"><input class="qty" type="number" step="0.01" value="${q}"></td>
    <td data-label="Price"><input class="price" type="number" step="0.01" value="${p}"></td>
    <td data-label="Markup"><input class="markup" type="number" step="0.01" value="${m}"></td>
    <td class="right lineTotal">R 0.00</td>
    <td><button class="btn outline" style="padding:8px 12px;">X</button></td>`;
  $('#itemsBody').appendChild(tr);
  tr.querySelectorAll('input').forEach(i => i.oninput = updateTotals);
  tr.querySelector('button').onclick = () => { tr.remove(); updateTotals(); };
}
$('#addItem').onclick = () => addItem();

function calculate() {
  const vatRate = +$('#vatRate').value / 100 || 0;
  const discRate = +$('#discountRate').value / 100 || 0;
  let subtotal = 0;
  const rows = $$('#itemsBody tr');
  rows.forEach(tr => {
    const qty = +tr.querySelector('.qty').value || 0;
    const price = +tr.querySelector('.price').value || 0;
    const markup = +tr.querySelector('.markup').value / 100 || 0;
    const total = qty * price * (1 + markup) * (1 + vatRate);
    subtotal += total;
    tr.querySelector('.lineTotal').textContent = fmt(total, $('#currency').value);
  });
  const discount = subtotal * discRate;
  const afterDisc = subtotal - discount;
  const vat = afterDisc * vatRate;
  const grand = afterDisc + vat;
  $('#subtotal').textContent = fmt(subtotal, $('#currency').value);
  $('#vat').textContent = fmt(vat, $('#currency').value);
  $('#grand').textContent = fmt(grand, $('#currency').value);
  return {subtotal, discount, vat, grand, rows};
}
$('#vatRate,#discountRate,#currency').oninput = calculate;
document.addEventListener('input', e => { if (e.target.matches('#itemsBody input')) calculate(); });

function getData() {
  const calc = calculate();
  return {
    type: $('#docType').value,
    number: $('#invNumber').value || $('#invNumber').value = prefixes[$('#docType').value] + String(+localStorage.getItem('c_'+$('#docType').value)).padStart(4,'0'),
    date: $('#invDate').value,
    due: $('#dueDate').value,
    po: $('#customerPO').value,
    currency: $('#currency').value,
    company: $('#clientCompany').value,
    rep: $('#clientRep').value,
    address: $('#clientAddress').value,
    email: $('#clientEmail').value,
    notes: $('#notes').value,
    payLink: $('#payLink').value,
    items: calc.rows.map(tr => ({
      desc: tr.querySelector('.desc').value,
      qty: +tr.querySelector('.qty').value,
      price: +tr.querySelector('.price').value,
      markup: +tr.querySelector('.markup').value
    })),
    totals: {subtotal: calc.subtotal, discount: calc.discount, vat: calc.vat, grand: calc.grand}
  };
}

$('#saveBtn').onclick = () => {
  const data = getData();
  let docs = JSON.parse(localStorage.getItem('docs')||'[]');
  docs = docs.filter(d => !(d.type===data.type && d.number===data.number));
  docs.push({...data, savedAt: Date.now()});
  localStorage.setItem('docs', JSON.stringify(docs));
  localStorage.setItem('c_'+data.type, String(+localStorage.getItem('c_'+data.type)+1));
  alert('Saved ' + data.number);
};

$('#pdfBtn').onclick = () => downloadPDF(getData());
async function downloadPDF(d) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const w = doc.internal.pageSize.getWidth();
  const m = 20;

  // Header
  doc.setFillColor(15,123,108);
  doc.rect(0,0,w,50,'F');
  doc.setTextColor(255,255,255);
  doc.setFontSize(22);
  doc.text(d.type==='QUOTE'?'QUOTE':d.type==='PRO_FORMA'?'PRO FORMA INVOICE':'TAX INVOICE', m, 35);
  doc.setFontSize(16);
  doc.text(d.number, w-m-doc.getTextWidth(d.number), 35);

  // Logo & Details
  try {
    const img = document.querySelector('#logo');
    if (img && img.complete) doc.addImage(img, 'PNG', m, 60, 45, 45);
  } catch(e) {}
  doc.setTextColor(0,0,0);
  doc.setFontSize(16); doc.text("Nico’s Auto & Agri", m+55, 75);
  doc.setFontSize(10);
  doc.text("98 Diemeer Str, Welgelegen, Polokwane, 0699", m+55, 85);
  doc.text("Tel: 079 568 1706 / 067 277 0183 • nicosauto@outlook.com", m+55, 93);

  doc.setFontSize(12);
  doc.text("Bill to:", 120, 75);
  doc.text(d.company, 120, 85);
  if (d.rep) doc.text("Attn: " + d.rep, 120, 95);
  if (d.address) doc.text(d.address.split('\n')[0], 120, 105);

  // Items Table
  const tableRows = d.items.map(i => [
    i.desc,
    i.qty,
    fmt(i.price * (1 + i.markup/100), d.currency),
    fmt(i.qty * i.price * (1 + i.markup/100) * (1 + +$('#vatRate').value/100), d.currency)
  ]);

  doc.autoTable({
    startY: 120,
    head: [['Description', 'Qty', 'Unit Price', 'Total']],
    body: tableRows,
    theme: 'striped',
    headStyles: {fillColor: [15,123,108]},
    styles: {fontSize: 10}
  });

  const y = doc.lastAutoTable.finalY + 15;
  doc.setFontSize(12);
  doc.text("Subtotal: " + fmt(d.totals.subtotal, d.currency), w-m-80, y);
  if (d.totals.discount) doc.text("Discount: -" + fmt(d.totals.discount, d.currency), w-m-80, y+10);
  doc.text("VAT: " + fmt(d.totals.vat, d.currency), w-m-80, y+20);
  doc.setFontSize(16);
  doc.text("TOTAL: " + fmt(d.totals.grand, d.currency), w-m-80, y+40);

  const note = d.notes || (d.type!=='TAX_INVOICE' ? 'Quote valid for 7 days • 5-day warranty • 2.5% card fee' : 'Thank you');
  doc.setFontSize(10);
  doc.text(doc.splitTextToSize(note, w-40), m, y+60);

  doc.setFontSize(9);
  doc.text("Banking: IC Schutte • Capitec Savings • 1680306187 • Branch 470010", m, doc.internal.pageSize.getHeight()-20);

  doc.save(d.number + '.pdf');
}

// Init
$('#invDate').value = $('#dueDate').value = DateTime.now().toISODate();
setNumber(); applyNote(); addItem(); addItem(); calculate();
</script>
</body>
</html>
