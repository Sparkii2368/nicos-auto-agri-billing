<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Nico’s Auto & Agri — Professional Billing System</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sanitize.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
<style>
  :root {
    --brand: #0f7b6c; /* Primary brand color */
    --accent: #eefaf7; /* Light accent */
    --ink: #1f2937; /* Dark text */
    --muted: #6b7280; /* Muted text */
    --bg: #f9fafb; /* Background */
    --line: #e5e7eb; /* Borders */
    --error: #ef4444; /* Error color */
    --success: #10b981; /* Success color */
  }
  body {
    font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--ink);
    padding: 24px;
    max-width: 1200px;
    margin: auto;
    line-height: 1.5;
  }
  nav {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
  }
  nav button {
    padding: 12px 20px;
    border: 1px solid var(--brand);
    border-radius: 8px;
    background: #fff;
    color: var(--brand);
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  nav button:hover {
    background: var(--accent);
  }
  nav button.active {
    background: var(--brand);
    color: #fff;
  }
  .sheet {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.08);
  }
  .sheet > header {
    display: flex;
    gap: 24px;
    align-items: center;
    border-bottom: 1px solid var(--line);
    padding-bottom: 16px;
    margin-bottom: 24px;
  }
  #logo {
    width: 200px;
    height: auto;
    object-fit: contain;
  }
  .brand-block h1 {
    margin: 0 0 8px 0;
    font-size: 24px;
    font-weight: 700;
    color: var(--brand);
  }
  .brand-sub {
    margin: 0;
    font-size: 14px;
    color: var(--muted);
    line-height: 1.5;
  }
  .company-details {
    margin: 8px 0 0 0;
    font-size: 14px;
    color: var(--muted);
    line-height: 1.5;
  }
  @media (max-width: 768px) {
    .sheet > header {
      flex-direction: column;
      text-align: center;
    }
    #logo {
      margin: 0 auto;
      width: 180px;
    }
  }

  .card {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 20px;
    margin-bottom: 20px;
  }
  .row {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 16px;
  }
  .col-6 { grid-column: span 6; }
  .col-4 { grid-column: span 4; }
  .col-3 { grid-column: span 3; }
  .col-2 { grid-column: span 2; }
  .col-12 { grid-column: span 12; }
  @media (max-width: 768px) {
    .col-6, .col-4, .col-3, .col-2 { grid-column: span 12; }
  }
  label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--muted);
    display: block;
    margin-bottom: 6px;
  }
  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--line);
    border-radius: 6px;
    font-size: 1rem;
    background: #fff;
    transition: border-color 0.2s ease;
  }
  input:focus, select:focus, textarea:focus {
    border-color: var(--brand);
    outline: none;
  }
  textarea {
    min-height: 100px;
    resize: vertical;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 12px;
    border-bottom: 1px solid var(--line);
    font-size: 0.95rem;
  }
  th {
    text-align: left;
    color: var(--muted);
    font-weight: 600;
  }
  tfoot td {
    border-top: 2px solid var(--line);
    font-weight: 600;
  }
  .btn {
    background: var(--brand);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .btn:hover {
    background: #0d6b5e;
  }
  .btn.outline {
    background: #fff;
    color: var(--brand);
    border: 1px solid var(--brand);
  }
  .btn.outline:hover {
    background: var(--accent);
  }
  .actions {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 16px;
  }
  .right { text-align: right; }
  .muted { color: var(--muted); }
  .pill {
    display: inline-block;
    background: var(--accent);
    color: var(--brand);
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.75rem;
    margin-left: 8px;
  }
  .hidden { display: none; }
  .table-actions button {
    padding: 8px 12px;
    border-radius: 6px;
    border: 1px solid var(--line);
    background: #fff;
    cursor: pointer;
    margin-right: 4px;
  }
  .search {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 16px;
  }
  .error-msg {
    color: var(--error);
    font-size: 0.875rem;
    margin-top: 4px;
  }
  .status-pill {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.8rem;
    text-transform: capitalize;
  }
  .status-open { background: #fef3c7; color: #d97706; }
  .status-paid { background: #d1fae5; color: #059669; }
  .status-overdue { background: #fee2e2; color: #ef4444; }
</style>
</head>
<body>

<nav>
  <button id="tabCreate" class="active" aria-label="Create new document">Create</button>
  <button id="tabRecords" aria-label="View saved records">Records</button>
</nav>

<section id="createView" class="sheet">
  <header>
    <img id="logo" src="logo.png" alt="Nico's Auto & Agri logo" decoding="async" onerror="this.style.display='none'">
    <div class="brand-block">
      <h1>Nico’s Auto & Agri — Invoice</h1>
      <p class="brand-sub">Professional Repairs • Genuine Parts • Accurate Diagnostics • Reliable Field Service</p>
      <p class="company-details">
        98 Diemeer Str, Welgelegen, Polokwane, 0699<br>
        Tel: 079 568 1706 / 067 277 0183 • Email: nicosauto@outlook.com
      </p>
    </div>
  </header>

  <div class="card">
    <div class="row">
      <div class="col-3">
        <label for="docType">Document Type</label>
        <select id="docType" aria-label="Document type">
          <option value="QUOTE">Quote</option>
          <option value="PRO_FORMA">Pro Forma Invoice</option>
          <option value="TAX_INVOICE" selected>Tax Invoice</option>
        </select>
      </div>
      <div class="col-3">
        <label for="customerPO">Customer Order Number</label>
        <input id="customerPO" placeholder="Customer PO / Order #" />
      </div>
      <div class="col-3">
        <label for="invNumber">Document Number</label>
        <input id="invNumber" aria-label="Document number" />
      </div>
      <div class="col-3">
        <label for="currency">Currency</label>
        <select id="currency" aria-label="Currency">
          <option value="ZAR" selected>ZAR (R)</option>
          <option value="USD">USD ($)</option>
          <option value="EUR">EUR (€)</option>
        </select>
      </div>

      <div class="col-4">
        <label for="invDate">Invoice Date</label>
        <input id="invDate" type="date" />
      </div>
      <div class="col-4">
        <label for="dueDate">Due Date</label>
        <input id="dueDate" type="date" />
      </div>
      <div class="col-4">
        <label for="vatRate">VAT Rate % <span class="pill">SA Default 15%</span></label>
        <input id="vatRate" type="number" step="0.01" value="15" />
      </div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div class="col-6">
        <label for="bizName">Your Business Name</label>
        <input id="bizName" value="Nico's Auto & Agri" readonly />
        <label for="bizDetails">Business Details</label>
        <input id="bizDetails" value="Tel: 079 568 1706 / 067 277 0183" />
        <label for="bizEmail">Business Email</label>
        <input id="bizEmail" value="nicosauto@outlook.com" />
        <label for="bizAddress">Business Address</label>
        <input id="bizAddress" value="98 Diemeer Str, Welgelegen, Polokwane, 0699" />
        <label for="bizVAT">VAT Number</label>
        <input id="bizVAT" placeholder="4xxxxxxxxx" />
      </div>
      <div class="col-6">
        <div class="row">
          <div class="col-12">
            <label for="clientCompany">Client Company Name</label>
            <input id="clientCompany" placeholder="Full company name" required />
            <div id="clientCompanyError" class="error-msg hidden">Required field</div>
          </div>
          <div class="col-12">
            <label for="clientRep">Company Representative</label>
            <input id="clientRep" placeholder="Contact person" />
          </div>
          <div class="col-12">
            <label for="clientVAT">Client VAT Number</label>
            <input id="clientVAT" placeholder="ZA VAT or international VAT" />
          </div>
          <div class="col-12">
            <label for="clientAddress">Client Address</label>
            <input id="clientAddress" placeholder="Street, City, Postal code" />
          </div>
          <div class="col-6">
            <label for="clientEmail">Client Email</label>
            <input id="clientEmail" type="email" placeholder="email@client.com" />
          </div>
          <div class="col-6">
            <label for="clientPicker">Saved Clients</label>
            <select id="clientPicker" aria-label="Saved clients"><option value="">— Select saved —</option></select>
          </div>
        </div>
        <div class="actions" style="margin-top:12px">
          <button class="btn outline" id="saveClientBtn" type="button">Save Client</button>
          <button class="btn outline" id="deleteClientBtn" type="button">Delete Client</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <label>Line Items</label>
    <table id="itemsTbl" aria-label="Line items table">
      <thead>
        <tr>
          <th style="width:45%">Description</th>
          <th>Quantity</th>
          <th>Unit Price</th>
          <th class="right">Line Total</th>
          <th aria-label="Actions"></th>
        </tr>
      </thead>
      <tbody id="itemsBody"></tbody>
      <tfoot>
        <tr>
          <td colspan="5"><button class="btn outline" id="addItem" type="button" aria-label="Add item">+ Add Item</button></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <div class="card">
    <div class="row">
      <div class="col-6">
        <label for="notes">Additional Notes / Terms</label>
        <textarea id="notes" placeholder="Thank you for your business. Payment is due within 7 days. Late payments may incur interest."></textarea>
        <label for="payLink">Payment Link (Optional)</label>
        <input id="payLink" placeholder="https://pay.yourdomain.co.za/invoice/..." />
      </div>
      <div class="col-6">
        <table aria-label="Totals" style="width:100%; margin-top:20px;">
          <tr><td>Subtotal</td><td class="right" id="subtotal">R 0.00</td></tr>
          <tr><td>Discount %</td><td class="right"><input id="discountRate" type="number" step="0.01" value="0" style="width:80px;" /></td></tr>
          <tr><td>VAT</td><td class="right" id="vat">R 0.00</td></tr>
          <tr><td><strong>Grand Total</strong></td><td class="right" id="grand">R 0.00</td></tr>
        </table>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="saveBtn" type="button">Save Document</button>
      <button class="btn" id="pdfBtn" type="button">Download PDF</button>
      <button class="btn outline" id="emailBtn" type="button">Send Email</button>
      <button class="btn outline" id="convertBtn" type="button">Convert to Tax Invoice</button>
    </div>
  </div>
</section>

<section id="recordsView" class="sheet hidden">
  <header>
    <img id="logo2" src="logo.png" alt="Nico's Auto & Agri logo" decoding="async" onerror="this.style.display='none'">
    <div class="brand-block">
      <h1>Document Records</h1>
      <p class="brand-sub">Manage Quotes, Pro Forma Invoices, and Tax Invoices</p>
      <p class="company-details">
        98 Diemeer Str, Welgelegen, Polokwane, 0699<br>
        Tel: 079 568 1706 / 067 277 0183
      </p>
    </div>
  </header>

  <div class="search">
    <input id="searchBox" placeholder="Search by client, number, amount..." aria-label="Search records" />
    <button class="btn outline" id="refreshBtn" type="button">Refresh List</button>
  </div>

  <div class="card">
    <h3>Quotes</h3>
    <table id="tblQuotes" aria-label="Quotes table">
      <thead><tr><th>Number</th><th>Date</th><th>Client</th><th class="right">Amount</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="card">
    <h3>Pro Forma Invoices</h3>
    <table id="tblProforma" aria-label="Pro forma table">
      <thead><tr><th>Number</th><th>Date</th><th>Client</th><th class="right">Amount</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="card">
    <h3>Tax Invoices</h3>
    <table id="tblTax" aria-label="Tax invoices table">
      <thead><tr><th>Number</th><th>Date</th><th>Client</th><th class="right">Amount</th><th>Status</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>
<script>
/* =====================================================
   HELPERS & CONFIG
===================================================== */
const $ = sel => document.querySelector(sel);
const itemsBody = () => $('#itemsBody');
const debounce = (fn, delay=250) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), delay); }; };

const fmt = (v, c) => {
  const sym = { ZAR: 'R', USD: '$', EUR: '€' }[c] || 'R';
  return `${sym} ${Number(v||0).toLocaleString('en-ZA', {minimumFractionDigits:2, maximumFractionDigits:2})}`;
};
const money = (v, c) => {
  const sym = { ZAR: 'R', USD: '$', EUR: '€' }[c] || 'R';
  return `${sym} ${Number(v||0).toFixed(2)}`;
};

const numberConfig = {
  QUOTE:      { prefix: 'QUO', counterKey: 'counter_QUOTE' },
  PRO_FORMA:  { prefix: 'PFI', counterKey: 'counter_PRO_FORMA' },
  TAX_INVOICE:{ prefix: 'NAA', counterKey: 'counter_TAX_INVOICE' }
};

const storage = {
  docsKey: 'docs',
  clientsKey: 'clients'
};

/* =====================================================
   NAVIGATION
===================================================== */
$('#tabCreate').addEventListener('click', ()=>showView('create'));
$('#tabRecords').addEventListener('click', ()=>showView('records'));
function showView(which){
  if (which==='create'){
    $('#createView').classList.remove('hidden');
    $('#recordsView').classList.add('hidden');
    $('#tabCreate').classList.add('active');
    $('#tabRecords').classList.remove('active');
    setTimeout(()=>{ $('#customerPO')?.focus(); }, 0);
  } else {
    refreshRecords();
    $('#createView').classList.add('hidden');
    $('#recordsView').classList.remove('hidden');
    $('#tabCreate').classList.remove('active');
    $('#tabRecords').classList.add('active');
  }
}

/* =====================================================
   READY
===================================================== */
function onReady(fn){
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', fn);
  else fn();
}

/* =====================================================
   INIT
===================================================== */
onReady(() => {
  Object.values(numberConfig).forEach(cfg=>{
    if (!localStorage.getItem(cfg.counterKey)) localStorage.setItem(cfg.counterKey,'1');
  });

  $('#currency').addEventListener('change', updateTotals);
  ['vatRate','discountRate'].forEach(id => $(`#${id}`).addEventListener('input', updateTotals));
  $('#addItem').addEventListener('click', addItem);
  $('#saveBtn').addEventListener('click', onSaveClick);
  $('#pdfBtn').addEventListener('click', () => downloadPDF());
  $('#emailBtn').addEventListener('click', onEmailClick);
  $('#convertBtn').addEventListener('click', onConvertToInvoice);
  $('#docType').addEventListener('change', onDocTypeChange);
  $('#clientPicker').addEventListener('change', onClientPick);
  $('#saveClientBtn').addEventListener('click', onSaveClient);
  $('#deleteClientBtn').addEventListener('click', onDeleteClient);
  $('#refreshBtn').addEventListener('click', refreshRecords);
  $('#searchBox').addEventListener('input', debounce(refreshRecords, 200));

  loadClients();
  autoSetup();
  addItem(); addItem();
  updateTotals();
});

/* =====================================================
   CLIENTS
===================================================== */
function clientLabel(c){
  const company = c.company || '';
  return c.rep ? `${company} — ${c.rep}` : company;
}

function getClientFormValues(){
  return {
    company: $('#clientCompany').value.trim(),
    rep: $('#clientRep').value.trim(),
    vat: $('#clientVAT').value.trim(),
    email: $('#clientEmail').value.trim(),
    address: $('#clientAddress').value.trim()
  };
}

function setClientForm(c = {}){
  $('#clientCompany').value = c.company || '';
  $('#clientRep').value = c.rep || '';
  $('#clientVAT').value = c.vat || '';
  $('#clientEmail').value = c.email || '';
  $('#clientAddress').value = c.address || '';
}

function loadClients(){
  let clients = JSON.parse(localStorage.getItem(storage.clientsKey) || '[]');
  const sel = $('#clientPicker');
  sel.innerHTML = '<option value="">— Select saved —</option>' + clients.map((c,i)=>`<option value="${i}">${clientLabel(c)}</option>`).join('');
}

function onClientPick(){
  const idx = parseInt($('#clientPicker').value, 10);
  if (isNaN(idx)) return;
  const clients = JSON.parse(localStorage.getItem(storage.clientsKey) || '[]');
  const c = clients[idx];
  if (c) setClientForm(c);
}

function onSaveClient(){
  const c = getClientFormValues();
  if (!c.company) {
    alert('Please enter a client company name.');
    return;
  }
  let clients = JSON.parse(localStorage.getItem(storage.clientsKey) || '[]');
  const existingIdx = clients.findIndex(x => x.company.toLowerCase() === c.company.toLowerCase());
  if (existingIdx >= 0) clients[existingIdx] = c;
  else clients.push(c);
  localStorage.setItem(storage.clientsKey, JSON.stringify(clients));
  loadClients();
  const idx = clients.findIndex(x => x.company.toLowerCase() === c.company.toLowerCase());
  if (idx >= 0) $('#clientPicker').value = String(idx);
  alert('Client saved successfully.');
}

function onDeleteClient(){
  const idx = parseInt($('#clientPicker').value, 10);
  if (isNaN(idx)) {
    alert('Please select a client to delete.');
    return;
  }
  let clients = JSON.parse(localStorage.getItem(storage.clientsKey) || '[]');
  const c = clients[idx];
  if (!c || !confirm(`Are you sure you want to delete "${clientLabel(c)}"?`)) return;
  clients.splice(idx, 1);
  localStorage.setItem(storage.clientsKey, JSON.stringify(clients));
  loadClients();
  alert('Client deleted successfully.');
}

/* =====================================================
   NUMBERS & DATES
===================================================== */
function autoSetup(){
  const now = luxon.DateTime.now().toISODate();
  $('#invDate').value = now;
  $('#dueDate').value = luxon.DateTime.now().plus({days:7}).toISODate();
  $('#currency').value = 'ZAR';
  ensureNumberFor($('#docType').value);
}

function onDocTypeChange(){
  ensureNumberFor($('#docType').value);
}

function ensureNumberFor(type){
  const cfg = numberConfig[type] || numberConfig.TAX_INVOICE;
  if (!$('#invNumber').value.trim()) $('#invNumber').value = nextNumber(cfg);
}

function nextNumber(cfg){
  const n = parseInt(localStorage.getItem(cfg.counterKey) || '1',10);
  return cfg.prefix + String(n).padStart(4,'0'); // Upgraded to 4 digits for professionalism
}

function incCounter(cfg){
  const n = parseInt(localStorage.getItem(cfg.counterKey) || '1',10) + 1;
  localStorage.setItem(cfg.counterKey, String(n));
}

/* =====================================================
   ITEMS & TOTALS
===================================================== */
function addItem(desc='', qty=1, price=0){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="desc" placeholder="Item description" value="${desc}" required></td>
    <td><input class="qty" type="number" step="0.01" min="0" value="${qty}"></td>
    <td><input class="price" type="number" step="0.01" min="0" value="${price}"></td>
    <td class="right lineTotal">${fmt(0, 'ZAR')}</td>
    <td class="right"><button class="btn outline del" type="button" aria-label="Remove item">Remove</button></td>
  `;
  itemsBody().appendChild(tr);
  tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', updateTotals));
  tr.querySelector('.del').addEventListener('click', () => { tr.remove(); updateTotals(); });
  updateTotals();
}

function gatherItems(){
  return [...itemsBody().querySelectorAll('tr')].map(r => {
    const d = r.querySelector('.desc').value.trim();
    const q = parseFloat(r.querySelector('.qty').value) || 0;
    const p = parseFloat(r.querySelector('.price').value) || 0;
    return {d, q, p, total: q * p};
  }).filter(i => i.d || i.q || i.p);
}

function updateTotals(){
  const currency = $('#currency').value;
  const items = gatherItems();
  let subtotal = items.reduce((s,i)=>s + i.total, 0);
  const discountRate = parseFloat($('#discountRate').value)||0;
  const vatRate = parseFloat($('#vatRate').value)||0;
  const discount = subtotal * (discountRate/100);
  const taxable = Math.max(0, subtotal - discount);
  const vat = taxable * (vatRate/100);
  const grand = taxable + vat;
  [...itemsBody().querySelectorAll('tr')].forEach((r,i) => {
    const t = items[i]?.total || 0;
    r.querySelector('.lineTotal').textContent = fmt(t, currency);
  });
  $('#subtotal').textContent = fmt(subtotal - discount, currency); // Updated to show after discount subtotal
  $('#vat').textContent = fmt(vat, currency);
  $('#grand').textContent = fmt(grand, currency);
}

function getTotals(){
  const items = gatherItems();
  let subtotal = items.reduce((s,i)=>s + i.total, 0);
  const discountRate = parseFloat($('#discountRate').value)||0;
  const discount = subtotal * (discountRate/100);
  const taxable = Math.max(0, subtotal - discount);
  const vatRate = parseFloat($('#vatRate').value)||0;
  const vat = taxable * (vatRate/100);
  const grand = taxable + vat;
  return {subtotal, discount, taxable, vat, grand, vatRate, discountRate};
}

/* =====================================================
   SAVE / RECORDS
===================================================== */
function readForm(){
  const client = getClientFormValues();
  return {
    type: $('#docType').value,
    bizName: $('#bizName').value.trim(),
    bizDetails: $('#bizDetails').value.trim(),
    bizEmail: $('#bizEmail').value.trim(),
    bizAddress: $('#bizAddress').value.trim(),
    bizVAT: $('#bizVAT').value.trim(),
    ...client,
    invNumber: $('#invNumber').value.trim(),
    invDate: $('#invDate').value,
    dueDate: $('#dueDate').value,
    customerPO: $('#customerPO').value.trim(),
    currency: $('#currency').value,
    vatRate: parseFloat($('#vatRate').value)||0,
    discountRate: parseFloat($('#discountRate').value)||0,
    payLink: $('#payLink').value.trim(),
    notes: $('#notes').value.trim(),
    items: gatherItems(),
    totals: getTotals(),
    status: 'open',
    savedAt: Date.now()
  };
}

function writeForm(d){
  $('#docType').value = d.type || 'TAX_INVOICE';
  $('#bizName').value = d.bizName || "Nico's Auto & Agri";
  $('#bizDetails').value = d.bizDetails || 'Tel: 079 568 1706 / 067 277 0183';
  $('#bizEmail').value = d.bizEmail || 'nicosauto@outlook.com';
  $('#bizAddress').value = d.bizAddress || '98 Diemeer Str, Welgelegen, Polokwane, 0699';
  $('#bizVAT').value = d.bizVAT || '';
  setClientForm(d);
  $('#invNumber').value = d.invNumber || '';
  $('#invDate').value = d.invDate || '';
  $('#dueDate').value = d.dueDate || '';
  $('#customerPO').value = d.customerPO || '';
  $('#currency').value = d.currency || 'ZAR';
  $('#vatRate').value = d.vatRate ?? 15;
  $('#discountRate').value = d.discountRate ?? 0;
  $('#payLink').value = d.payLink || '';
  $('#notes').value = d.notes || '';
  itemsBody().innerHTML = '';
  (d.items||[]).forEach(i=>addItem(i.d,i.q,i.p));
  if ((d.items||[]).length < 2) { addItem(); addItem(); }
  updateTotals();
}

function saveDoc(inv, inc = true){
  let list = JSON.parse(localStorage.getItem(storage.docsKey) || '[]');
  const idx = list.findIndex(x => x.invNumber === inv.invNumber && x.type === inv.type);
  if (idx >= 0) list[idx] = inv;
  else list.push(inv);
  localStorage.setItem(storage.docsKey, JSON.stringify(list));
  if (inc) {
    const cfg = numberConfig[inv.type];
    if (inv.invNumber === nextNumber(cfg)) incCounter(cfg);
  }
}

function resetFormForNext(type){
  const docType = type || $('#docType').value || 'TAX_INVOICE';
  $('#docType').value = docType;
  ensureNumberFor(docType);
  const now = luxon.DateTime.now().toISODate();
  $('#invDate').value = now;
  $('#dueDate').value = luxon.DateTime.now().plus({days:7}).toISODate();
  setClientForm();
  $('#customerPO').value = '';
  $('#discountRate').value = 0;
  $('#notes').value = '';
  $('#payLink').value = '';
  itemsBody().innerHTML = '';
  addItem(); addItem();
  updateTotals();
  $('#clientPicker').value = '';
  setTimeout(()=>$('#clientCompany').focus(), 0);
}

function validateForm(inv){
  if (!inv.company) {
    $('#clientCompanyError').classList.remove('hidden');
    $('#clientCompany').focus();
    return false;
  } else {
    $('#clientCompanyError').classList.add('hidden');
  }
  return true;
}

function onSaveClick(){
  const inv = readForm();
  if (!validateForm(inv)) return;
  const cfg = numberConfig[inv.type];
  if (!inv.invNumber) {
    inv.invNumber = nextNumber(cfg);
    $('#invNumber').value = inv.invNumber;
  }
  saveDoc(inv);
  alert('Document saved successfully.');
  resetFormForNext(inv.type);
}

async function onEmailClick(){
  const inv = readForm();
  if (!validateForm(inv)) return;
  const cfg = numberConfig[inv.type];
  if (!inv.invNumber) {
    inv.invNumber = nextNumber(cfg);
    $('#invNumber').value = inv.invNumber;
  }
  saveDoc(inv);
  await downloadPDF(true); // silent download for attachment
  openEmailDraft(inv);
}

function openEmailDraft(inv){
  const label = clientLabel(inv);
  const greet = inv.rep || label;
  const subject = encodeURIComponent(`${labelForType(inv.type)} ${inv.invNumber} from ${inv.bizName}`);
  const body = encodeURIComponent([
    `Dear ${greet},`,
    '',
    `Attached is your ${labelForType(inv.type).toLowerCase()} ${inv.invNumber} for your records.`,
    inv.customerPO ? `Referencing your PO: ${inv.customerPO}` : '',
    `Total amount due: ${money(inv.totals.grand, inv.currency)} (including VAT at ${inv.vatRate}%)`,
    inv.dueDate ? `Payment due by: ${inv.dueDate}` : '',
    inv.payLink ? `Secure payment link: ${inv.payLink}` : '',
    '',
    inv.notes || 'We appreciate your business and look forward to serving you again.',
    '',
    'Best regards,',
    inv.bizName,
    inv.bizDetails,
    inv.bizEmail
  ].filter(Boolean).join('\n'));
  location.href = `mailto:${inv.email}?subject=${subject}&body=${body}`;
}

function labelForType(t){
  return t==='QUOTE'?'Quote':t==='PRO_FORMA'?'Pro Forma Invoice':'Tax Invoice';
}

/* =====================================================
   CONVERT TO INVOICE
===================================================== */
async function onConvertToInvoice(){
  const current = readForm();
  if (!validateForm(current)) return;
  if (current.type === 'TAX_INVOICE') {
    alert('Already a tax invoice.');
    return;
  }
  current.status = 'converted';
  saveDoc(current, false);
  const newDoc = { ...current, type: 'TAX_INVOICE', status: 'open' };
  const cfg = numberConfig.TAX_INVOICE;
  newDoc.invNumber = nextNumber(cfg);
  newDoc.invDate = luxon.DateTime.now().toISODate();
  newDoc.dueDate = luxon.DateTime.now().plus({days:7}).toISODate();
  newDoc.notes = `${newDoc.notes ? newDoc.notes + '\n\n' : ''}Converted from ${labelForType(current.type)} ${current.invNumber}.`;
  writeForm(newDoc);
  updateTotals();
  await downloadPDF();
  saveDoc(readForm());
  alert('Successfully converted to tax invoice.');
}

/* =====================================================
   RECORDS VIEW
===================================================== */
function refreshRecords(){
  const tables = {
    QUOTE: $('#tblQuotes tbody'),
    PRO_FORMA: $('#tblProforma tbody'),
    TAX_INVOICE: $('#tblTax tbody')
  };
  Object.values(tables).forEach(tb => tb.innerHTML = '');
  const q = ($('#searchBox').value || '').toLowerCase();
  let list = JSON.parse(localStorage.getItem(storage.docsKey) || '[]');
  list.sort((a,b) => b.savedAt - a.savedAt);
  list.forEach(d => {
    const total = d.totals?.grand || 0;
    const label = clientLabel(d);
    if (![d.invNumber, label, total.toString()].join(' ').toLowerCase().includes(q)) return;
    const statusClass = `status-pill status-${d.status}`;
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${d.invNumber}</td>
      <td>${d.invDate}</td>
      <td>${label}</td>
      <td class="right">${fmt(total, d.currency)}</td>
      <td><span class="${statusClass}">${d.status}</span></td>
      <td class="table-actions">
        <button data-num="${d.invNumber}" data-type="${d.type}" class="openBtn">Edit</button>
        <button data-num="${d.invNumber}" data-type="${d.type}" class="pdfBtn">PDF</button>
        <button data-num="${d.invNumber}" data-type="${d.type}" class="emailRecordBtn">Email</button>
        <button data-num="${d.invNumber}" data-type="${d.type}" class="paidBtn">${d.status === 'paid' ? 'Unmark Paid' : 'Mark Paid'}</button>
        <button data-num="${d.invNumber}" data-type="${d.type}" class="delBtn">Delete</button>
      </td>
    `;
    tables[d.type].appendChild(row);
  });
  document.querySelectorAll('.openBtn').forEach(b => b.addEventListener('click', openRecord));
  document.querySelectorAll('.pdfBtn').forEach(b => b.addEventListener('click', pdfRecord));
  document.querySelectorAll('.emailRecordBtn').forEach(b => b.addEventListener('click', emailRecord));
  document.querySelectorAll('.paidBtn').forEach(b => b.addEventListener('click', togglePaid));
  document.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', deleteRecord));
}

function getRecord(e){
  const num = e.target.dataset.num;
  const type = e.target.dataset.type;
  const list = JSON.parse(localStorage.getItem(storage.docsKey) || '[]');
  return list.find(x => x.invNumber === num && x.type === type);
}

function openRecord(e){
  const doc = getRecord(e);
  if (doc) {
    showView('create');
    writeForm(doc);
    updateTotals();
  }
}

async function pdfRecord(e){
  const doc = getRecord(e);
  if (doc) {
    writeForm(doc);
    await downloadPDF();
  }
}

function emailRecord(e){
  const doc = getRecord(e);
  if (doc) openEmailDraft(doc);
}

function togglePaid(e){
  const doc = getRecord(e);
  if (doc) {
    doc.status = doc.status === 'paid' ? 'open' : 'paid';
    saveDoc(doc, false);
    refreshRecords();
  }
}

function deleteRecord(e){
  const num = e.target.dataset.num;
  const type = e.target.dataset.type;
  if (!confirm(`Delete ${type} ${num}? This action cannot be undone.`)) return;
  let list = JSON.parse(localStorage.getItem(storage.docsKey) || '[]');
  const idx = list.findIndex(x => x.invNumber === num && x.type === type);
  if (idx >= 0) {
    list.splice(idx, 1);
    localStorage.setItem(storage.docsKey, JSON.stringify(list));
    refreshRecords();
  }
}

/* =====================================================
   PDF GENERATION
===================================================== */
function wrapText(doc, text, x, y, maxW, lineHeight = 14){
  const lines = doc.splitTextToSize(text || '', maxW);
  lines.forEach((line, i) => doc.text(line, x, y + i * lineHeight));
  return y + lines.length * lineHeight;
}

async function getHeaderLogo() {
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.src = 'logo.png';
  return new Promise((resolve, reject) => {
    img.onload = () => resolve(img);
    img.onerror = reject;
  });
}

function detectImgType(src) {
  const ext = src.split('.').pop().toLowerCase();
  return ext === 'jpg' || ext === 'jpeg' ? 'JPEG' : ext === 'webp' ? 'WEBP' : 'PNG';
}

function imgToDataURL(img) {
  const canvas = document.createElement('canvas');
  canvas.width = img.width;
  canvas.height = img.height;
  canvas.getContext('2d').drawImage(img, 0, 0);
  return canvas.toDataURL('image/png');
}

async function downloadPDF(silent = false){
  const inv = readForm();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: 'pt', format: 'a4' });
  const M = 40; // Increased margin for professionalism
  const W = doc.internal.pageSize.getWidth();
  const H = doc.internal.pageSize.getHeight();
  const BRAND = [15,123,108], INK = [31,41,55], MUTED = [107,114,128], BG = [249,250,251];

  // Header band
  doc.setFillColor(...BRAND);
  doc.rect(0, 0, W, 80, 'F');
  doc.setTextColor(255,255,255);
  doc.setFont('helvetica', 'bold').setFontSize(20);
  doc.text(labelForType(inv.type).toUpperCase(), M, 50);
  if (inv.invNumber) doc.text(`#${inv.invNumber}`, W - M - doc.getTextWidth(`#${inv.invNumber}`), 50);

  // Logo
  let logoY = 100;
  try {
    const logo = await getHeaderLogo();
    const logoW = 180, logoH = logo.height * (logoW / logo.width);
    const type = detectImgType(logo.src);
    try {
      doc.addImage(logo, type, M, logoY, logoW, logoH);
    } catch {
      const dataURL = imgToDataURL(logo);
      if (dataURL) doc.addImage(dataURL, 'PNG', M, logoY, logoW, logoH);
    }
    logoY += logoH + 20;
  } catch {}

  // Business details
  doc.setFont('helvetica', 'bold').setFontSize(16).setTextColor(...INK);
  doc.text(inv.bizName, M, logoY);
  doc.setFont('helvetica', 'normal').setFontSize(10).setTextColor(...MUTED);
  logoY = wrapText(doc, 'Repairs • Parts • Diagnostics • Field Service', M, logoY + 14, 300);
  logoY = wrapText(doc, inv.bizAddress, M, logoY + 8, 300);
  if (inv.bizVAT) logoY = wrapText(doc, `VAT: ${inv.bizVAT}`, M, logoY + 8, 300);
  logoY = wrapText(doc, inv.bizDetails + ' • ' + inv.bizEmail, M, logoY + 8, 300);

  // Bill to section
  const billX = W / 2;
  doc.setFont('helvetica', 'bold').setFontSize(12).setTextColor(...INK);
  let billY = 100;
  doc.text('Billed To:', billX, billY);
  doc.setFont('helvetica', 'normal').setFontSize(10).setTextColor(...MUTED);
  billY = wrapText(doc, inv.company, billX, billY + 14, 240);
  if (inv.rep) billY = wrapText(doc, `Attn: ${inv.rep}`, billX, billY + 8, 240);
  if (inv.vat) billY = wrapText(doc, `VAT: ${inv.vat}`, billX, billY + 8, 240);
  if (inv.address) billY = wrapText(doc, inv.address, billX, billY + 8, 240);
  if (inv.email) billY = wrapText(doc, inv.email, billX, billY + 8, 240);

  // Dates section
  const datesY = Math.max(logoY + 20, billY + 20);
  doc.setFont('helvetica', 'normal').setFontSize(10).setTextColor(...MUTED);
  doc.text(`Invoice Date: ${inv.invDate || ''}`, M, datesY);
  doc.text(`Due Date: ${inv.dueDate || ''}`, M + 200, datesY);
  if (inv.customerPO) doc.text(`Customer PO: ${inv.customerPO}`, M, datesY + 14);

  // Items table
  const tableY = datesY + 40;
  const body = inv.items.map(i => [i.d, i.q.toFixed(2), money(i.p, inv.currency), money(i.total, inv.currency)]);
  doc.autoTable({
    startY: tableY,
    head: [['Description', 'Quantity', 'Unit Price', 'Line Total']],
    body,
    theme: 'grid',
    styles: { font: 'helvetica', fontSize: 10, cellPadding: 8, lineColor: var(--line), textColor: INK },
    headStyles: { fillColor: BG, textColor: INK, fontStyle: 'bold' },
    columnStyles: {
      0: { cellWidth: 250 },
      1: { cellWidth: 80, halign: 'right' },
      2: { cellWidth: 100, halign: 'right' },
      3: { cellWidth: 100, halign: 'right' }
    },
    margin: { left: M, right: M }
  });

  // Totals
  let totalsY = doc.lastAutoTable.finalY + 20;
  const t = inv.totals;
  doc.setFont('helvetica', 'bold').setFontSize(11);
  doc.text('Summary', W - M - 200, totalsY);
  doc.setFont('helvetica', 'normal').setFontSize(10);
  totalsY += 14;
  doc.text(`Subtotal:`, W - M - 200, totalsY);
  doc.text(money(t.subtotal, inv.currency), W - M, totalsY, { align: 'right' });
  totalsY += 14;
  doc.text(`Discount (${t.discountRate}%):`, W - M - 200, totalsY);
  doc.text(`-${money(t.discount, inv.currency)}`, W - M, totalsY, { align: 'right' });
  totalsY += 14;
  doc.text(`VAT (${t.vatRate}%):`, W - M - 200, totalsY);
  doc.text(money(t.vat, inv.currency), W - M, totalsY, { align: 'right' });
  totalsY += 14;
  doc.setFont('helvetica', 'bold');
  doc.text(`Grand Total:`, W - M - 200, totalsY);
  doc.text(money(t.grand, inv.currency), W - M, totalsY, { align: 'right' });

  // Notes and payment
  let notesY = totalsY + 30;
  if (inv.payLink) {
    doc.setTextColor(...BRAND);
    doc.textWithLink('Pay Online Now', M, notesY, { url: inv.payLink });
    notesY += 20;
  }
  doc.setTextColor(...INK);
  doc.setFont('helvetica', 'normal').setFontSize(10);
  notesY = wrapText(doc, inv.notes, M, notesY, W - 2 * M);

  // Banking details
  let bankY = notesY + 40;
  if (bankY > H - 150) {
    doc.addPage();
    bankY = 40;
  }
  doc.setFont('helvetica', 'bold').setFontSize(11).setTextColor(...INK);
  doc.text('Banking Details', M, bankY);
  doc.setFont('helvetica', 'normal').setFontSize(10).setTextColor(...MUTED);
  bankY += 14;
  bankY = wrapText(doc, 'Account Name: IC Schutte', M, bankY, 300);
  bankY = wrapText(doc, 'Bank: Capitec Savings', M, bankY, 300);
  bankY = wrapText(doc, 'Account Number: 1680306187', M, bankY, 300);
  bankY = wrapText(doc, 'Branch Code: 470010', M, bankY, 300);

  // Footer
  doc.setFontSize(9).setTextColor(...MUTED);
  doc.text(`${inv.bizName} • ${inv.bizEmail} • All rights reserved.`, M, H - 20);
  doc.text(`Page 1 of 1`, W - M, H - 20, { align: 'right' });

  const filename = `${labelForType(inv.type).replace(/\s/g, '_')}_${inv.invNumber}.pdf`;
  if (silent) doc.save(filename, { returnPromise: true });
  else doc.save(filename);
}
</script>
</body>
</html>